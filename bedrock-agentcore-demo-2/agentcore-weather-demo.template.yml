AWSTemplateFormatVersion: 2010-09-09
Description: AgentCore Hello World stack - Execution Role + ECR Repo

Parameters:
  AgentName:
    Type: String
    Default: weather-agent
    Description: Agent name used for resources
  MemoryName:
    Type: String
    Default: weather_memory
    Description: Name for the Bedrock AgentCore Memory resource

Resources:
  AgentCoreExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub BedrockAgentCoreExec-${AgentName}
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock-agentcore.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:*
      Policies:
        - PolicyName: BedrockAgentCoreExecutionPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - ecr:BatchGetImage
                  - ecr:GetDownloadUrlForLayer
                Resource: !Sub arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/*
              - Effect: Allow
                Action:
                - logs:Describe*
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
                Resource: "*"
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: "*"
              - Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                  - xray:GetSamplingRules
                  - xray:GetSamplingTargets
                Resource: "*"
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
                Condition:
                  StringEquals:
                    cloudwatch:namespace: bedrock-agentcore
              - Effect: Allow
                Action:
                  - bedrock-agentcore:GetWorkloadAccessToken
                  - bedrock-agentcore:GetWorkloadAccessTokenForJWT
                  - bedrock-agentcore:GetWorkloadAccessTokenForUserId
                Resource:
                  - !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default
                  - !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default/workload-identity/${AgentName}-*
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource:
                  - !Sub arn:aws:bedrock:*::foundation-model/*
                  - !Sub arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:*
              - Effect: Allow
                Action:
                  - bedrock-agentcore:*Memory
                  - bedrock-agentcore:*Memories
                  - bedrock-agentcore:*Event
                Resource: "*"

  AgentCoreECRRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub bedrock-agentcore-${AgentName}
      ImageScanningConfiguration:
        scanOnPush: true
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Expire untagged images after 14 days",
                "selection": {
                  "tagStatus": "untagged",
                  "countType": "sinceImagePushed",
                  "countUnit": "days",
                  "countNumber": 14
                },
                "action": { "type": "expire" }
              }
            ]
          }

  AgentCoreMemory:
    Type: AWS::BedrockAgentCore::Memory
    Properties:
      Name: !Ref MemoryName
      Description: Weather agent conversation memory
      EventExpiryDuration: 7

Outputs:
  RoleArn:
    Description: Execution role ARN for AgentCore runtime
    Value: !GetAtt AgentCoreExecutionRole.Arn
  RoleName:
    Description: Execution role name
    Value: !Ref AgentCoreExecutionRole
  RepositoryUri:
    Description: URI of the ECR repository
    Value: !GetAtt AgentCoreECRRepo.RepositoryUri
  MemoryId:
    Description: ID of the Bedrock AgentCore Memory resource
    Value: !GetAtt AgentCoreMemory.MemoryId
